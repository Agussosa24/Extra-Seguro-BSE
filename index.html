<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>FORMULARIO EXTRA SEGURO</title>
  <link rel="stylesheet" href="estilo.css" />
</head>
<body>
  <div id="contenidoPDF">
    <div class="header">
  <img src="Cars.JPG" alt="Logo Cars" class="logo" />
</div>
    <h2>FORMULARIO EXTRA SEGURO</h2>

    <div class="datos">
      <div class="contenedor-izquierda">
        <form id="dataForm">
          <div class="fila-formulario">
            <div class="form-group">
              <label><span>Taller N°:</span> <input type="text" id="taller" required /></label>
              <label><span>Serie y N°:</span> <input type="text" id="serieNumero" required /></label>
            </div>
          </div>
        </form>

        <div class="imagen-y-campos">
          <div class="canvas-section">
            <canvas id="canvas" width="700" height="350"></canvas>
            <button class="clear-button" type="button" onclick="clearCanvas()">Limpiar Dibujo</button>
          </div>
        </div>
      </div>

      <form class="columna-derecha">
        <div class="fecha">
          <label class="Fecha"><span>Fecha:</span> <input type="date" id="fecha" required /></label>
        </div>
        <div class="stro">
          <label class="siniestro"><span>Siniestro:</span> <input type="text" id="siniestro" required /></label>
          <label class="visual"><span>¿Dificulta visual?:</span> <input type="text" id="dificultadVisual" /></label>
        </div>
      </form>
    </div>

    <div class="texto">
      <h3>SE INFORMAN RUBROS CUYOS PORCENTAJES NO SE TENDRAN EN CUENTA EN FUTURAS RECLAMACIONES</h3>
      <h3>ANULA / REMPLAZA EXTRA SEGURO DE FECHA:</h3>
    </div>

    <div class="tablas-piezas">
      <table id="tablaPiezas1">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Guardabarro del der</td><td><input type="text" name="piezas" list="opciones-piezas"/></td><td><input type="text" /></td></tr>
          <tr><td>Guardabarro del izq</td><td><input type="text" name="piezas" list="opciones-piezas"/></td><td><input type="text" /></td></tr>
          <tr><td>Parabrisas</td><td><input type="text" name="piezas" list="opciones-piezas"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>

      <table id="tablaPiezas2">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>Guardabarro del der</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>Guardabarro del izq</td><td><input type="text" name="piezas" list="opciones-piezas"/></td><td><input type="text" /></td></tr>
          <tr><td>Parabrisas</td><td><input type="text" name="piezas" list="opciones-piezas"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>
      <datalist id="opciones-piezas">
        <option value="Manzana">
        <option value="Mandarina">
        <option value="Melón">
        <option value="Mango">
      </datalist>
    </div>
  </div>

  <form id="boton">
    <div style="text-align: center; margin: 30px 0;">
      <button type="submit">Generar PDF</button>
    </div>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- SCRIPT FUNCIONAL -->

<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let baseImageData = null;
  let userHasDrawn = false;

  const image = new Image();
  image.src = "parabrisa.png";
  image.crossOrigin = "anonymous";

  image.onload = () => {
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    // ⚠️ Guardamos la imagen base solo cuando ya esté cargada completamente
    baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  };

  function canvasEstaModificado() {
    const actual = ctx.getImageData(0, 0, canvas.width, canvas.height);
    if (!baseImageData) return false;

    for (let i = 0; i < actual.data.length; i++) {
      if (actual.data[i] !== baseImageData.data[i]) {
        return true; // hay algo diferente
      }
    }
    return false; // es igual que la imagen original
  }

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
    userHasDrawn = false;
    // Actualizamos baseImageData al nuevo "canvas limpio"
    baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  }

  window.clearCanvas = clearCanvas;

  // EVENTOS DE DIBUJO
  let drawing = false;

  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    return evt.touches
      ? { x: evt.touches[0].clientX - rect.left, y: evt.touches[0].clientY - rect.top }
      : { x: evt.offsetX, y: evt.offsetY };
  }

  function startDraw(evt) {
    evt.preventDefault();
    drawing = true;
    const pos = getPos(evt);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(evt) {
    if (!drawing) return;
    evt.preventDefault();
    const pos = getPos(evt);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "red";
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
    userHasDrawn = true;
  }

  function endDraw(evt) {
    evt.preventDefault();
    drawing = false;
    ctx.beginPath();
  }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  canvas.addEventListener("touchstart", startDraw, { passive: false });
  canvas.addEventListener("touchmove", draw, { passive: false });
  canvas.addEventListener("touchend", endDraw);
  canvas.addEventListener("touchcancel", endDraw);

  // BOTÓN SUBMIT
  document.getElementById("boton").addEventListener("submit", function (event) {
    event.preventDefault();

    const taller = document.getElementById("taller").value.trim();
    const serieNumero = document.getElementById("serieNumero").value.trim();
    const siniestro = document.getElementById("siniestro").value.trim();
    const fecha = document.getElementById("fecha").value.trim();
    const dificultadVisual = document.getElementById("dificultadVisual").value.trim();

    if (!taller || !serieNumero || !siniestro || !fecha) {
      alert("Por favor complete todos los campos antes de generar el PDF.");
      return;
    }

    // ✅ Evaluamos si hay dibujo
    const hayDibujo = canvasEstaModificado();

    if (userHasDrawn && !dificultadVisual) {
      alert("Por favor describa la dificultad visual asociada al dibujo.");
      return;
    }

    const confirmar = confirm("Verifica que el número de siniestro esté tipeado correctamente. ¿Deseas continuar?");
    if (!confirmar) return;

    const botones = document.querySelectorAll("button");
    botones.forEach(btn => btn.style.display = "none");

    html2pdf()
      .from(document.getElementById("contenidoPDF"))
      .set({
        margin: 0.5,
        filename: "formulario_con_dibujo.pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
      })
      .save()
      .then(() => {
        botones.forEach(btn => btn.style.display = "inline-block");
      });
  });
</script>
<script>
function agregarFilaSiEsUltima(input, tablaId) {
  const tabla = document.getElementById(tablaId);
  const filas = tabla.querySelectorAll("tbody tr");
  const ultimaFila = filas[filas.length - 1];

  if (ultimaFila.contains(input)) {
    const nuevaFila = ultimaFila.cloneNode(true);

    // Limpiar los inputs
    nuevaFila.querySelectorAll("input").forEach(input => input.value = "");

    tabla.querySelector("tbody").appendChild(nuevaFila);
  }
}

// Función para asignar eventos de escucha a inputs de ambas tablas
function inicializarAutofila(tablaId) {
  const tabla = document.getElementById(tablaId);
  tabla.addEventListener("input", function (e) {
    if (e.target.tagName === "INPUT") {
      agregarFilaSiEsUltima(e.target, tablaId);
    }
  });
}

// Inicializar para ambas tablas
inicializarAutofila("tablaPiezas1");
inicializarAutofila("tablaPiezas2");
</script>

</body>
</html>

