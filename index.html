<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FORMULARIO EXTRA SEGURO</title>
  <link rel="stylesheet" href="estilo.css" />
</head>
<body>
  <div id="escalado">
    <div id="contenidoPDF">
      <div class="header">
        <img src="Cars.JPG" alt="Logo Cars" class="logo" />
      </div>
      <h2>FORMULARIO EXTRA SEGURO</h2>

      <div class="datos">
        <div class="contenedor-izquierda">
          <form id="dataForm">
            <div class="fila-formulario">
              <div class="form-group">
                <label><span>Taller N°:</span> <input type="text" id="taller" required /></label>
                <label><span>Serie y N°:</span> <input type="text" id="serieNumero" required /></label>
              </div>
            </div>
          </form>

          <div class="imagen-y-campos">
            <div class="canvas-section">
              <canvas id="canvas" width="700" height="350"></canvas>
              <button class="clear-button" type="button" onclick="clearCanvas()">Limpiar Dibujo</button>
            </div>
          </div>
        </div>

        <form class="columna-derecha">
          <div class="fecha">
            <label class="Fecha"><span>Fecha:</span> <input type="date" id="fecha" required /></label>
          </div>
          <div class="stro">
            <label class="siniestro"><span>Siniestro:</span> <input type="text" id="siniestro" required /></label>
            <label class="visual"><span>¿Dificulta visual?:</span> <input type="text" id="dificultadVisual" /></label>
          </div>
        </form>
      </div>

      <div class="texto">
        <h3>SE INFORMAN RUBROS CUYOS PORCENTAJES NO SE TENDRAN EN CUENTA EN FUTURAS RECLAMACIONES</h3>
        <h3>ANULA / REMPLAZA EXTRA SEGURO DE FECHA:</h3>
      </div>

      <div class="tablas-piezas">
        <table id="tablaPiezas1">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>GUARDABARRO DEL DER</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO DEL IZQ</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ESPOLON</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>CARETA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARAGOLPE DELANTERO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUNTERA P/GOLPE DEL DER</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUNTERA P/GOLPE DEL IZQ</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEMIOPTICA DERECHA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEMIOPTICA IZQUIERDA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEÑALERO DEL DER</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEÑALERO DEL IZQ</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA DELANTERA DERECHA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA DELANTERA IZQUIERDA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PORTON TRAS DER</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PORTON TRAS IZQ</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO TRAS DER</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO TRAS IZQ</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>TECHO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARABRISAS</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td id="autocomplete" placeholder="" autocomplete="off"><input type="text" /></td><td><input type="text"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>

      <table id="tablaPiezas2">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>PANEL TRASERO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>TAPA VALIJA / PORTON TRAS.</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARAGOLPE TRASERO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUNTERA P/GOLPE TRAS DER</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUNTERA P/GOLPE TRAS IZQ</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>FAROL TRASERO DERECHO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>FAROL TRASERO IZQUIERDO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ZOCALO DERECHO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ZOCALO IZQUIERDO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>LUNETA TRASERA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>MOLDURA sup tapa caja</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>LATERAL DERECHO CAJA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>LATERAL IZQUIERDO CAJA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>FRENTE DE CHAPA</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA TRASERA DER</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA TRASERA IZQ</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PORTON LATERAL DERECHO</td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>CHORIZO DE TECHO IZQ </td><td><input type="text" id="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td><input type="text" /></td><td><input type="text" name="piezas" list="opciones-piezas"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>
      
      </div>

      <form id="boton">
          <div style="text-align: center; margin: 30px 0;">
            <button type="submit" class="boton">Generar PDF</button>
          </div>
        </form>
      
    </div>
    
  </div>

  <!-- Scripts -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
<script>
const input = document.getElementById("text");

input.addEventListener("input", function() {
  // Crea un elemento temporal para medir el texto
  const span = document.createElement("span");
  span.style.visibility = "hidden";
  span.style.position = "absolute";
  span.style.whiteSpace = "pre";
  span.style.font = window.getComputedStyle(input).font;

  span.textContent = input.value || input.placeholder;

  document.body.appendChild(span);
  const ancho = span.offsetWidth + 10; // +10 px de margen para no cortar letras
  document.body.removeChild(span);

  input.style.width = ancho + "px";
});
</script>
  
  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let baseImageData = null;
    let userHasDrawn = false;

    const image = new Image();
    image.src = "parabrisa.png";
    image.crossOrigin = "anonymous";

    image.onload = () => {
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    };

    function canvasEstaModificado() {
      const actual = ctx.getImageData(0, 0, canvas.width, canvas.height);
      if (!baseImageData) return false;

      for (let i = 0; i < actual.data.length; i++) {
        if (actual.data[i] !== baseImageData.data[i]) {
          return true;
        }
      }
      return false;
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
      userHasDrawn = false;
      baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }

    window.clearCanvas = clearCanvas;

    let drawing = false;

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      return evt.touches
        ? { x: evt.touches[0].clientX - rect.left, y: evt.touches[0].clientY - rect.top }
        : { x: evt.offsetX, y: evt.offsetY };
    }

    function startDraw(evt) {
      evt.preventDefault();
      drawing = true;
      const pos = getPos(evt);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function draw(evt) {
      if (!drawing) return;
      evt.preventDefault();
      const pos = getPos(evt);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "red";
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
      userHasDrawn = true;
    }

    function endDraw(evt) {
      evt.preventDefault();
      drawing = false;
      ctx.beginPath();
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", endDraw);
    canvas.addEventListener("mouseleave", endDraw);
    canvas.addEventListener("touchstart", startDraw, { passive: false });
    canvas.addEventListener("touchmove", draw, { passive: false });
    canvas.addEventListener("touchend", endDraw);
    canvas.addEventListener("touchcancel", endDraw);

        function getPos(evt) {
          const rect = canvas.getBoundingClientRect();
          const escalaX = canvas.width / rect.width;
          const escalaY = canvas.height / rect.height;
        
          const x = evt.touches
            ? (evt.touches[0].clientX - rect.left) * escalaX
            : (evt.clientX - rect.left) * escalaX;
        
          const y = evt.touches
            ? (evt.touches[0].clientY - rect.top) * escalaY
            : (evt.clientY - rect.top) * escalaY;
        
          return { x, y };
        }
document.getElementById("boton").addEventListener("submit", function (event) {
  event.preventDefault();

  const taller = document.getElementById("taller").value.trim();
  const serieNumero = document.getElementById("serieNumero").value.trim();
  const siniestro = document.getElementById("siniestro").value.trim();
  const fecha = document.getElementById("fecha").value.trim();
  const dificultadVisual = document.getElementById("dificultadVisual").value.trim();

  if (!taller || !serieNumero || !siniestro || !fecha) {
    alert("Por favor complete todos los campos antes de generar el PDF.");
    return;
  }

  if (userHasDrawn && !dificultadVisual) {
    alert("Por favor describa la dificultad visual asociada al dibujo.");
    return;
  }

  const confirmar = confirm("Verifica que el número de siniestro esté tipeado correctamente. ¿Deseas continuar?");
  if (!confirmar) return;

  const botones = document.querySelectorAll("button");
  botones.forEach(btn => btn.style.display = "none");

  const body = document.body;
  const escalado = document.getElementById("escalado");
  const transformAnterior = escalado.style.transform;

  // 🔵 Aplica estilos PDF
  body.classList.add("modo-pdf");
  escalado.style.transform = "none";

  // Suponiendo que el input tiene un id
const inputNombre = document.querySelector('#siniestro'); // cambia #stro por el id real de tu input

// Valor que escribieron
let nombreArchivo = inputNombre.value.trim();

// Si está vacío, ponemos uno por defecto
if (!nombreArchivo) {
  nombreArchivo = 'formulario_con_dibujo';
}
  setTimeout(() => {
    html2pdf()
      .from(document.getElementById("contenidoPDF"))
      .set({
        margin: [5, 7, 10, 7],
        filename: `${nombreArchivo}.pdf`,
        image: { type: "jpeg", quality: 1 },
        html2canvas: {
          scale: 2,
          useCORS: true
        },
        jsPDF: {
          unit: "mm",
          format: "a4",
          orientation: "portrait"
        }
      })
      .save()
      .then(() => {
        // ✅ Restaurar todo
        body.classList.remove("modo-pdf");
        escalado.style.transform = transformAnterior;
        botones.forEach(btn => btn.style.display = "inline-block");
        escalarPagina();
      });
  }, 200);
});

    function agregarFilaSiEsUltima(input, tablaId) {
      const tabla = document.getElementById(tablaId);
      const filas = tabla.querySelectorAll("tbody tr");
      const ultimaFila = filas[filas.length - 1];

      if (ultimaFila.contains(input)) {
        const nuevaFila = ultimaFila.cloneNode(true);
        nuevaFila.querySelectorAll("input").forEach(input => input.value = "");
        tabla.querySelector("tbody").appendChild(nuevaFila);
      }
    }

    function inicializarAutofila(tablaId) {
      const tabla = document.getElementById(tablaId);
      tabla.addEventListener("input", function (e) {
        if (e.target.tagName === "INPUT") {
           agregarFilaSiEsUltima(e.target, tablaId);
        }
      });
    }

    inicializarAutofila("tablaPiezas1");
    inicializarAutofila("tablaPiezas2");
  </script>

  <!-- Escalado automático -->
  <script>
  function escalarPagina() {
    const baseWidth = 1200;
    const escala = Math.min(window.innerWidth / baseWidth, 1);
    const escalado = document.getElementById('escalado');

    escalado.style.transform = `scale(${escala})`;
    escalado.style.transformOrigin = 'top center'; // 🔴 Esto es clave para que no desplace hacia abajo

    // Ajustar el alto del body al tamaño escalado real
    const altoEscalado = escalado.getBoundingClientRect().height;
    document.body.style.height = `${altoEscalado}px`;
  }

  window.addEventListener('resize', escalarPagina);
  window.addEventListener('load', escalarPagina);
</script>
  
<script>
  const sugerencias = ["Prueba", "Mandarina", "Melón", "Mango"];
  const td = document.getElementById("autocomplete");

  let ultimaEntrada = "";

  input.addEventListener("input", () => {
    const valor = input.value.toLowerCase();

    // Evita sugerir si el usuario está borrando
    if (valor.length < ultimaEntrada.length) {
      ultimaEntrada = valor;
      return;
    }

    const match = sugerencias.find(opcion => opcion.toLowerCase().startsWith(valor));
    if (match && valor !== match.toLowerCase()) {
      input.value = match;
      input.setSelectionRange(valor.length, match.length); // subraya lo sugerido
    }

    ultimaEntrada = valor;
  });
</script>
    
</script>
