<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FORMULARIO EXTRA SEGURO</title>
  <link rel="stylesheet" href="estilo.css" />
</head>
<body>
  <div id="escalado">
    <div id="contenidoPDF">
      <div class="header">
        <img src="Cars.JPG" alt="Logo Cars" class="logo" />
      </div>
      <h2>FORMULARIO EXTRA SEGURO</h2>

      <div class="datos">
        <div class="contenedor-izquierda">
          <form id="dataForm">
            <div class="fila-formulario">
              <div class="form-group">
                <label><span>Taller N°:</span> <input type="text" id="taller" required /></label>
                <label><span>Serie y N°:</span> <input type="text" id="serieNumero" required /></label>
              </div>
            </div>
          </form>

          <div class="imagen-y-campos">
            <div class="canvas-section">
              <canvas id="canvas" width="700" height="350"></canvas>
              <button class="clear-button" type="button" onclick="clearCanvas()">Limpiar Dibujo</button>
            </div>
          </div>
        </div>

        <form class="columna-derecha">
          <div class="fecha">
            <label class="Fecha"><span>Fecha:</span> <input type="date" id="fecha" required /></label>
          </div>
          <div class="stro">
            <label class="siniestro"><span>Siniestro:</span> <input type="text" id="siniestro" required /></label>
            <label class="visual"><span>¿Dificulta visual?:</span> <input type="text" id="dificultadVisual" /></label>
          </div>
        </form>
      </div>

      <div class="texto">
        <h3>SE INFORMAN RUBROS CUYOS PORCENTAJES NO SE TENDRAN EN CUENTA EN FUTURAS RECLAMACIONES</h3>
        <h3>ANULA / REMPLAZA EXTRA SEGURO DE FECHA:</h3>
      </div>

      <div class="tablas-piezas">
        <table id="tablaPiezas1">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>GUARDABARRO DEL DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO DEL IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>CARETA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARAGOLPE DELANTERO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ESPEJO DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ESPEJO IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEMIOPTICA DERECHA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>SEMIOPTICA IZQUIERDA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA DELANTERA DERECHA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA DELANTERA IZQUIERDA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA TRASERA DERECHA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PUERTA TRASERA IZQUIERDA</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PORTON TRAS DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PORTON TRAS IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td><input class="autocomplete" type="text" autocomplete="off" spellcheck="false" placeholder="Escribe..."/></td><td><input type="text"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>

      <table id="tablaPiezas2">
        <thead>
          <tr>
            <th>PIEZA / ACCESORIOS</th>
            <th>CHAPA</th>
            <th>PINTURA</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>ESPOLON</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO TRAS DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>GUARDABARRO TRAS IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>TECHO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARABRISAS</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PANEL TRASERO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>TAPA VALIJA / PORTON TRAS.</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>PARAGOLPE TRASERO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ZOCALO DERECHO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>ZOCALO IZQUIERDO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>LATERAL DERECHO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>LATERAL IZQUIERDO</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>FARO TRAS DER</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td>FARO TRAS IZQ</td><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text" /></td></tr>
          <tr><td><input type="text" class="autocomplete" placeholder="" autocomplete="off"/></td><td><input type="text"/></td><td><input type="text" /></td></tr>
        </tbody>
      </table>
      
      </div>

      <form id="boton">
          <div style="text-align: center; margin: 30px 0;">
            <button type="button" class="boton">Generar PDF</button>
          </div>
        </form>
      
    </div>
    
  </div>

  <!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.36.0/js/msal-browser.min.js"></script>

<!-- Ajuste dinámico de input -->
<script>
const input = document.getElementById("text");

input.addEventListener("input", function() {
  const span = document.createElement("span");
  span.style.visibility = "hidden";
  span.style.position = "absolute";
  span.style.whiteSpace = "pre";
  span.style.font = window.getComputedStyle(input).font;

  span.textContent = input.value || input.placeholder;

  document.body.appendChild(span);
  const ancho = span.offsetWidth + 10;
  document.body.removeChild(span);

  input.style.width = ancho + "px";
});
</script>

<!-- Canvas con parabrisas -->
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let baseImageData = null;
let userHasDrawn = false;

const image = new Image();
image.src = "parabrisa.png"; // ⚠️ asegúrate que el archivo exista en la misma carpeta
image.onload = () => {
  ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
  baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
};

function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
  userHasDrawn = false;
  baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
}
window.clearCanvas = clearCanvas;

let drawing = false;

function getPos(evt) {
  const rect = canvas.getBoundingClientRect();
  const escalaX = canvas.width / rect.width;
  const escalaY = canvas.height / rect.height;

  const x = evt.touches
    ? (evt.touches[0].clientX - rect.left) * escalaX
    : (evt.clientX - rect.left) * escalaX;

  const y = evt.touches
    ? (evt.touches[0].clientY - rect.top) * escalaY
    : (evt.clientY - rect.top) * escalaY;

  return { x, y };
}

function startDraw(evt) {
  evt.preventDefault();
  drawing = true;
  const pos = getPos(evt);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
}

function draw(evt) {
  if (!drawing) return;
  evt.preventDefault();
  const pos = getPos(evt);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "red";
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
  userHasDrawn = true;
}

function endDraw(evt) {
  evt.preventDefault();
  drawing = false;
  ctx.beginPath();
}

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("mouseup", endDraw);
canvas.addEventListener("mouseleave", endDraw);
canvas.addEventListener("touchstart", startDraw, { passive: false });
canvas.addEventListener("touchmove", draw, { passive: false });
canvas.addEventListener("touchend", endDraw);
canvas.addEventListener("touchcancel", endDraw);
</script>

<!-- Generación de PDF + subida a OneDrive -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelector("#boton .boton").addEventListener("click", async (e) => {
    e.preventDefault();

    const taller = document.getElementById("taller").value.trim();
    const serieNumero = document.getElementById("serieNumero").value.trim();
    const siniestro = document.getElementById("siniestro").value.trim();
    const fechaInput = document.getElementById("fecha");
    const dificultadVisual = document.getElementById("dificultadVisual").value.trim();

    if (!taller || !serieNumero || !siniestro || !fechaInput.value) {
      alert("⚠️ Por favor complete todos los campos antes de generar el PDF.");
      return;
    }

    if (userHasDrawn && !dificultadVisual) {
      alert("⚠️ Por favor describa la dificultad visual asociada al dibujo.");
      return;
    }

    // Formateo de fecha dd/mm/aaaa
    const fechaParts = fechaInput.value.split("-");
    const fechaFormateada = `${fechaParts[2]}/${fechaParts[1]}/${fechaParts[0]}`;
    const fechaLabel = fechaInput.parentElement;
    const spanFecha = document.createElement("span");
    spanFecha.textContent = fechaFormateada;
    fechaLabel.appendChild(spanFecha);
    fechaInput.style.display = "none";

    const confirmar = confirm("¿El número de siniestro ingresado es correcto: " + siniestro + " ?");
    if (!confirmar) {
      fechaInput.style.display = "inline";
      fechaLabel.removeChild(spanFecha);
      return;
    }

    // Configuración MSAL
    const msalConfig = {
      auth: {
        clientId: "TU_CLIENT_ID",
        redirectUri: window.location.href
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: true
      }
    };
    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginRequest = { scopes: ["Files.ReadWrite.All"] };

    async function loginAndGetToken() {
      try {
        const tokenResponse = await msalInstance.acquireTokenSilent(loginRequest);
        return tokenResponse.accessToken;
      } catch {
        await msalInstance.loginPopup(loginRequest);
        const tokenResponse = await msalInstance.acquireTokenPopup(loginRequest);
        return tokenResponse.accessToken;
      }
    }

    async function subirPDF() {
      const element = document.getElementById("contenidoPDF");
      const blob = await html2pdf().from(element).output('blob');
      const arrayBuffer = await blob.arrayBuffer();
      const filenameInput = document.getElementById("siniestro").value.trim() || "Formulario";
      const filename = `${filenameInput}.pdf`;
      const accessToken = await loginAndGetToken();
      const url = `https://graph.microsoft.com/v1.0/me/drive/root:/Extra-Seguro-BSE/${filename}:/content`;

      try {
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/pdf"
          },
          body: arrayBuffer
        });

        if(res.ok){
          alert("✅ PDF subido correctamente a SharePoint");
        } else {
          alert("❌ Error al subir PDF: " + res.status);
        }
      } catch(err) {
        alert("❌ Error de conexión: " + err.message);
      }
    }

    // Subir PDF
    await subirPDF();

    // Restaurar estado del formulario
    fechaInput.style.display = "inline";
    fechaLabel.removeChild(spanFecha);
  });
});
</script>

<!-- Escalado automático -->
<script>
function escalarPagina() {
  const baseWidth = 1200;
  const escala = Math.min(window.innerWidth / baseWidth, 1);
  const escalado = document.getElementById('escalado');

  escalado.style.transform = `scale(${escala})`;
  escalado.style.transformOrigin = 'top center';

  const altoEscalado = escalado.getBoundingClientRect().height;
  document.body.style.height = `${altoEscalado}px`;
}

window.addEventListener('resize', escalarPagina);
window.addEventListener('load', escalarPagina);
</script>

<!-- Autocompletar -->
<script>
const sugerencias = ["PUNTERA P/GOLPE DEL DER", "PUNTERA P/GOLPE DEL IZQ", "SEÑALERO DEL DER", "SEÑALERO DEL IZQ", "PUNTERA P/GOLPE TRAS DER", "PUNTERA P/GOLPE TRAS IZQ", "LUNETA TRASERA", "MOLDURA sup tapa caja", "FRENTE DE CHAPA", "PORTON LATERAL DERECHO", "CHORIZO DE TECHO IZQ"];

function aplicarAutocompletado(inputAuto) {
  let ultimaEntrada = "";

  inputAuto.addEventListener("input", () => {
    const valor = inputAuto.value.toLowerCase();

    if (valor.length < ultimaEntrada.length) {
      ultimaEntrada = valor;
      return;
    }

    const match = sugerencias.find(opcion => opcion.toLowerCase().startsWith(valor));
    if (match && valor !== match.toLowerCase()) {
      inputAuto.value = match;
      inputAuto.setSelectionRange(valor.length, match.length);
    }

    ultimaEntrada = valor;
  });
}

document.querySelectorAll(".autocomplete").forEach(aplicarAutocompletado);

function agregarFilaSiEsUltima(input, tablaId) {
  const tabla = document.getElementById(tablaId);
  const filas = tabla.querySelectorAll("tbody tr");
  const ultimaFila = filas[filas.length - 1];

  if (ultimaFila.contains(input)) {
    const nuevaFila = ultimaFila.cloneNode(true);
    nuevaFila.querySelectorAll("input").forEach(input => input.value = "");
    tabla.querySelector("tbody").appendChild(nuevaFila);
    nuevaFila.querySelectorAll(".autocomplete").forEach(aplicarAutocompletado);
  }
}

function inicializarAutofila(tablaId) {
  const tabla = document.getElementById(tablaId);
  tabla.addEventListener("input", function (e) {
    if (e.target.tagName === "INPUT") {
      agregarFilaSiEsUltima(e.target, tablaId);
    }
  });
}

inicializarAutofila("tablaPiezas1");
inicializarAutofila("tablaPiezas2");
</script>
